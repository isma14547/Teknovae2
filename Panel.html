<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Gestión de Productos - Teknovae</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de la fuente Inter para todo el cuerpo -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos personalizados para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
    </style>
    <!-- Incluir iconos de Lucide (para un toque moderno) -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

    <!-- Encabezado del Panel -->
    <header class="bg-indigo-700 text-white shadow-lg p-4">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold">Panel de Gestión de Productos</h1>
        </div>
    </header>

    <!-- Caja de Mensajes (para éxito/error) -->
    <div id="message-box" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg shadow-md z-50 transition-opacity duration-500 ease-in-out opacity-0" role="alert">
        <p id="message-text" class="font-semibold"></p>
    </div>

    <!-- Modal de Confirmación Personalizado -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-auto">
            <p id="confirm-modal-message" class="text-lg text-gray-800 mb-6 text-center">¿Estás seguro de esto?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                    Cancelar
                </button>
                <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Contenido Principal del Panel -->
    <main class="container mx-auto p-6 flex-grow">
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <h2 class="text-xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">Añadir Producto</h2>
            <p class="text-red-600 text-center mb-4 font-semibold">
                ¡Atención! Las imágenes subidas aquí se guardan solo temporalmente en tu navegador y se perderán al recargar la página. Para almacenamiento permanente, se requiere un servicio de alojamiento de imágenes externo.
            </p>
            <form id="add-product-form" class="max-w-xl mx-auto space-y-4">
                <div>
                    <label for="product-name" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Producto:</label>
                    <input type="text" id="product-name" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="product-description" class="block text-gray-700 text-sm font-bold mb-2">Descripción:</label>
                    <textarea id="product-description" rows="3" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
                </div>
                <div>
                    <label for="product-price" class="block text-gray-700 text-sm font-bold mb-2">Precio:</label>
                    <input type="number" id="product-price" step="0.01" min="0" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label for="product-image-file" class="block text-gray-700 text-sm font-bold mb-2">Subir Imagen:</label>
                    <input type="file" id="product-image-file" accept="image/*" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <img id="image-preview" class="mt-4 hidden w-32 h-32 object-cover rounded-md border border-gray-300" src="" alt="Previsualización de imagen">
                </div>
                <div class="flex justify-center">
                    <button type="submit" id="add-product-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transform hover:scale-105 transition duration-300 focus:outline-none">
                        <i data-lucide="plus-circle" class="inline-block w-5 h-5 mr-2"></i> Añadir Producto
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">Lista de Productos Actual</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Nombre</th>
                            <th class="py-3 px-6 text-left">Descripción</th>
                            <th class="py-3 px-6 text-left">Precio</th>
                            <th class="py-3 px-6 text-left">Imagen</th>
                            <th class="py-3 px-6 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="text-gray-700 text-sm font-light">
                        <!-- Los productos se cargarán aquí dinámicamente -->
                        <tr><td colspan="5" class="py-4 text-center text-gray-500">Cargando productos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Pie de Página -->
    <footer class="bg-gray-800 text-white p-6 mt-8">
        <div class="container mx-auto text-center">
            <p>&copy; 2024 Teknovae Admin. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module">
        // Variables para los elementos del DOM
        let productNameInput;
        let productDescriptionInput;
        let productPriceInput;
        let productImageFileInput;
        let imagePreview;
        let productsTableBody;
        
        const LOCAL_STORAGE_KEY = 'teknovae_products';

        /**
         * Carga los productos del almacenamiento local.
         * @returns {Array<Object>} - El array de productos.
         */
        function getProductsFromLocalStorage() {
            console.log("Intentando leer productos del almacenamiento local...");
            try {
                const products = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];
                console.log("Productos cargados exitosamente:", products);
                return products;
            } catch (e) {
                console.error("Error al leer los productos del almacenamiento local:", e);
                return [];
            }
        }

        /**
         * Guarda los productos en el almacenamiento local.
         * @param {Array<Object>} products - El array de productos a guardar.
         */
        function saveProductsToLocalStorage(products) {
            console.log("Intentando guardar productos en el almacenamiento local:", products);
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(products));
                console.log("Productos guardados exitosamente.");
            } catch (e) {
                console.error("Error al guardar los productos en el almacenamiento local:", e);
                displayMessage("Error al guardar los productos localmente.", "error");
            }
        }

        /**
         * Convierte un archivo de imagen a una URL Base64.
         * @param {File} file - El archivo de imagen.
         * @returns {Promise<string>} - Una promesa que resuelve con la URL Base64.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        /**
         * Añade un nuevo producto a la lista y lo guarda.
         * @param {Event} event - El evento de envío del formulario.
         */
        async function addProduct(event) {
            event.preventDefault(); // Prevenir el envío por defecto del formulario

            // Obtener los valores del formulario
            const name = productNameInput.value.trim();
            const description = productDescriptionInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            const imageFile = productImageFileInput.files[0];

            // Validar que todos los campos estén llenos y el precio sea válido
            if (!name || !description || isNaN(price) || price <= 0) {
                displayMessage("Por favor, rellena todos los campos correctamente (el precio debe ser un número positivo).", "error");
                return;
            }

            let imageUrl = '';
            if (imageFile) {
                try {
                    imageUrl = await fileToBase64(imageFile);
                } catch (e) {
                    console.error("Error al convertir la imagen a Base64:", e);
                    displayMessage("Error al procesar la imagen. Intenta con otra.", "error");
                    return;
                }
            } else {
                imageUrl = 'https://placehold.co/400x300/cccccc/333333?text=Sin+Imagen';
            }
            
            // Generar un ID único para el producto
            const productId = Date.now().toString();

            const newProduct = {
                id: productId,
                name,
                description,
                price: price.toFixed(2), // Guardar el precio con 2 decimales
                imageUrl,
            };

            console.log("Nuevo producto a añadir:", newProduct);

            const products = getProductsFromLocalStorage();
            products.push(newProduct);
            saveProductsToLocalStorage(products);
            renderProducts(products); // Renderizar la lista actualizada

            displayMessage("Producto añadido con éxito.", "success");

            // Limpiar los campos del formulario
            productNameInput.value = '';
            productDescriptionInput.value = '';
            productPriceInput.value = '';
            productImageFileInput.value = '';
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
        }

        /**
         * Elimina un producto de la lista y lo guarda.
         * @param {string} productId - El ID del producto a eliminar.
         */
        async function deleteProduct(productId) {
            if (!await showConfirmModal("¿Estás seguro de que quieres eliminar este producto de forma permanente?")) {
                return; // El usuario canceló
            }

            console.log("Intentando eliminar producto con ID:", productId);
            let products = getProductsFromLocalStorage();
            products = products.filter(product => product.id !== productId);
            saveProductsToLocalStorage(products);
            renderProducts(products); // Renderizar la lista actualizada

            displayMessage("Producto eliminado con éxito.", "success");
        }

        /**
         * Renderiza los productos del array recibido en la tabla.
         * @param {Array<Object>} products - Array de objetos de productos.
         */
        function renderProducts(products) {
            productsTableBody.innerHTML = ''; // Limpiar las filas de la tabla existentes
            console.log("Renderizando productos en la tabla:", products);

            if (products.length === 0) {
                productsTableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No hay productos en la lista.</td></tr>`;
                return;
            }

            products.forEach(product => {
                const row = productsTableBody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-50';

                row.insertCell(0).textContent = product.name;
                row.insertCell(1).textContent = product.description;
                row.insertCell(2).textContent = `$${product.price}`;
                const imgCell = row.insertCell(3);
                const img = document.createElement('img');
                img.src = product.imageUrl || 'https://placehold.co/50x50/cccccc/333333?text=No+Img';
                img.alt = product.name;
                img.className = 'w-12 h-12 object-cover rounded-md';
                img.onerror = () => { img.src = 'https://placehold.co/50x50/cccccc/333333?text=Error'; };
                imgCell.appendChild(img);

                const actionsCell = row.insertCell(4);
                actionsCell.className = 'text-center';
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-red-600 hover:text-red-800 transition duration-300 focus:outline-none p-2 rounded-full hover:bg-red-100';
                deleteButton.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
                deleteButton.addEventListener('click', () => deleteProduct(product.id));
                actionsCell.appendChild(deleteButton);
            });
            lucide.createIcons(); // Volver a renderizar los iconos de Lucide para los nuevos elementos
        }

        /**
         * Muestra un mensaje temporal en la UI.
         * @param {string} message - El mensaje a mostrar.
         * @param {'success'|'error'} type - El tipo de mensaje (para estilos).
         */
        function displayMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-red-100', 'border-red-400', 'text-red-700');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            }
            messageBox.classList.remove('opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 500); // Esperar a que termine la transición de opacidad
            }, 3000); // Ocultar después de 3 segundos
        }

        /**
         * Muestra un modal de confirmación personalizado.
         * @param {string} message - El mensaje de confirmación.
         * @returns {Promise<boolean>} - Resuelve a true si el usuario confirma, false si cancela.
         */
        function showConfirmModal(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const modalMessage = document.getElementById('confirm-modal-message');
                const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
                const cancelBtn = document.getElementById('confirm-modal-cancel-btn');

                modalMessage.textContent = message;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }
        
        /**
         * Inicializa la aplicación y los listeners.
         */
        async function initializeMainApp() {
             console.log("Aplicación inicializada. Cargando elementos del DOM...");
             // Obtener elementos del DOM
            productNameInput = document.getElementById('product-name');
            productDescriptionInput = document.getElementById('product-description');
            productPriceInput = document.getElementById('product-price');
            productImageFileInput = document.getElementById('product-image-file');
            imagePreview = document.getElementById('image-preview');
            productsTableBody = document.getElementById('products-table-body');

            // Cargar los productos existentes del almacenamiento local y renderizarlos
            const products = getProductsFromLocalStorage();
            renderProducts(products);

            // Añadir el event listener para el envío del formulario
            document.getElementById('add-product-form').addEventListener('submit', addProduct);

            // Listener para previsualizar la imagen seleccionada
            productImageFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = '';
                    imagePreview.classList.add('hidden');
                }
            });
            
            // Inicializar iconos de Lucide para elementos estáticos
            lucide.createIcons();
            console.log("Aplicación lista y renderizada.");
        }
        
        // Llamar a la función de inicialización cuando el DOM esté cargado
        document.addEventListener('DOMContentLoaded', initializeMainApp);

    </script>
</body>
</html>
